<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Search Result</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/stylesheet.css">
    </head>
    <body>
        <header>
            <div class="mobile">
                <a href="index.html" >
                    <img src="../images/back.png"/>
                </a>
                <div id="to-from"></div>
                <div id="search-info"></div>
                <div class="login-signup">
                    <img src="../images/account.png"/>
                    <div class="login-signup-links">
                        <a href="../login.html">Login</a>
                        <a href="../signup.html">Sign-up</a>
                    </div>
                </div>
            </div>
            <div class="desktop">
                <div class="logo_div">
                    <img src="../images/logo-white.png"/>
                    <p>We makes it easy for you</p>
                </div>
                <div class="login-signup">
                    <img src="../images/account-white.png"/>
                    <div class="login-signup-links">
                        <a href="login.html">Login</a>
                        <a href="signup.html">Sign-up</a>
                    </div>
                </div>
                
            </div>
        </header>
        <nav class="flight-nav">
            <div id="nav_card" class="desktop">
                <div class="nav_button">
                    <a href="index.html">
                        <img src="../images/flight.png" />
                        <p>Flights</p>
                    </a>
                </div>
                <div class="nav_button">
                    <a href="../trains/index.html">
                        <img src="../images/train.png" />
                        <p>Trains</p>
                    </a>
                </div>
                <div class="nav_button">
                    <a href="../hotels/index.html">
                        <img src="../images/hotel.png" />
                        <p>Hotels</p>
                    </a>
                </div>
            </div>
        </nav>
        <main>
            <div class="flight-search-types desktop">
                <div id="one" class="flight-search-type-active">
                    <button onclick="updateSearch('one')">
                        <img src="images/tick.png"/>
                        <p>ONE WAY</p>
                    </button>
                </div>
                <div id="round" class="flight-search-type-inactive">
                    <button onclick="updateSearch('round')">
                        <img src="images/tick.png"/>
                        <p>ROUNDTRIP</p>
                    </button>
                </div>
            </div>
            <div class="main_container desktop">
                <div class="inputs">
                    <div class="full-section">
                        <p class="heading">From</p>
                        <p class="input"><input id="from_city" /></p>
                    </div>
                    <div class="full-section">
                        <p class="heading">TO</p>
                        <p class="input"><input id="to_city" /></p>
                    </div>
                    <div class="input-section">
                        <div class="inner-div">
                            <p class="heading">DEPARTURE</p>
                            <p class="input"><input id="departure" type="date"/></p>
                        </div>
                        <div class="inner-div">
                            <p class="heading">RETURN</p>
                            <p class="input"><input id="return" type="date" disabled  /></p>
                        </div>
                    </div>
                    <div class="input-section">
                        <div class="inner-div">
                            <p class="heading">TRAVELLERS</p>
                            <p class="input"><input id="travellers" type="number" max="10"/></p>
                        </div>
                        <div class="inner-div">
                            <p class="heading">CABIN CLASS</p>
                            <p class="input">
                                <select id="class" >
                                    <option value="Economy">Economy</option>
                                    <option value="Premium-economy">Premium-economy</option>
                                    <option value="Business">Business</option>
                                </select>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="button-div">
                    <button onclick="search()">SEARCH</button>
                </div>
            </div>
            <div class="progres_div" id="progres_div">
                <progress>Loading...</progress>
            </div>
            <div id="no_flights" class="no_flights mobile">
                <img src="../images/world-problem.png" />
                <p id="paragraph_error">No Flights Found</p>
            </div>
            <div id="flight_info_container" name="flight_info_container" class="flight_info_container">
                <!-- <div class='flight_info' onclick='flightInfoClicked("0",false)'><p>Alaska Airlines</p><div class='side_info'><div>00:00</div><div class='lower_info'>San Francisco</div></div><div class='side_info'><div>Non Stop</div><div class='lower_info'>New York</div></div><div class='side_info price'>$252</div></div> -->
            </div>
            <div class="recent-flights" id="recent-flights"></div>
            <div class="custom-info" id="custom-info"></div>
            <p class="section-title">Travel during Pandemic</p>
            <div class="safety">
                <div class="safety-card">
                    <p class="card-title">
                        Test yourself
                    </p>
                    <p class="card-info">
                        The first thing that you need to do is get yourself tested for the virus to ensure that you are not a carrier. 
                        Anyone exhibiting mild signs of illness and is unable to provide a report showing that he isn't infected can't travel.
                    </p>
                </div>
                <div class="safety-card">
                    <p class="card-title">
                        Get medical history
                    </p>
                    <p class="card-info">
                        Your medical history is your best friend under these circumstances. Make sure that you have all the necessary paperwork to 
                        prove that you haven't faced an illness that might indicate that you were a carrier of the virus.
                    </p>
                </div>
                <div class="safety-card">
                    <p class="card-title">
                        Get travel history
                    </p>
                    <p class="card-info">
                        The most common way of contracting this virus is by  traveling  from one place to another and coming in contact with different people. 
                        Any person who has been in another part of the world in the past 14 days have the same risks.
                    </p>
                </div>
                <div class="safety-card">
                    <p class="card-title">
                        Carry all essentials
                    </p>
                    <p class="card-info">
                        Make sure that you have all the necessary things that you need to ensure exceptional hygiene. Wear a pair of gloves, carry alcohol wipes 
                        and hand sanitizers, and remember that the face mask isn't must to wear. 
                    </p>
                </div>
                <div class="safety-card">
                    <p class="card-title">
                        Remember the guidelines
                    </p>
                    <p class="card-info">
                        And on top of all this, remember the  fundamental guidelines  issued to ensure your safety. Maintain a safe distance of about two meters from everyone, 
                        avoid touching things or people, and don't step into crowded places. 
                    </p>
                </div>
            </div>
        </main>
        <footer>
            <p>&copy; Copyright 2020. All Rights Reserved.</p>
        </footer>
        <script type="text/javascript" src="../scripts/basicFunctions.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <script>
            var response1;
            
            function updateSearch(type)
            {
                if(type == "one")
                {
                    var element = document.getElementById("one");
                    element.classList.remove(element.classList);
                    element.classList.add('flight-search-type-active');
                    element = document.getElementById("round");
                    element.classList.remove(element.classList);
                    element.classList.add("flight-search-type-inactive");
                    element = document.getElementById("return");
                    element.disabled = true;
                }
                else if(type == "round")
                {
                    var element = document.getElementById("round");
                    element.classList.remove(element.classList);
                    element.classList.add("flight-search-type-active");
                    element = document.getElementById("return");
                    element.disabled = false;
                    element = document.getElementById("one");
                    element.classList.remove(element.classList);
                    element.classList.add("flight-search-type-inactive");
                }
            }

            function search()
            {
                var cond = true;
                var from_city = document.getElementById("from_city").value;
                //console.log(from_city);
                if(from_city == "")
                {
                    document.getElementById("from_city").style.borderBottom = "0.1em solid red";
                    cond = false;
                }
                var to_city = document.getElementById("to_city").value;
                //console.log(to_city);
                if(to_city == "")
                {
                    document.getElementById("to_city").style.borderBottom = "0.1em solid red";
                    cond = false;
                }
                var departure = document.getElementById("departure").value;
                //console.log(departure);
                if(departure == "")
                {
                    document.getElementById("departure").style.borderBottom = "0.1em solid red";
                    cond = false;
                }
                var vreturn = document.getElementById("return").value;
                //console.log(vreturn);
                //console.log("1. document.getElementById('return').disabled: "+document.getElementById("return").disabled+" vreturn: "+vreturn);
                if(document.getElementById("return").disabled)
                {
                    vreturn = "";
                }
                //console.log("2. document.getElementById('return').disabled: "+document.getElementById("return").disabled+" vreturn: "+vreturn);
                if(!document.getElementById("return").disabled && vreturn == "")
                {
                    document.getElementById("return").style.borderBottom = "0.1em solid red";
                    cond = false;
                }
                // else
                // {
                //     vreturn = "";
                // }
                //console.log("3. document.getElementById('return').disabled: "+document.getElementById("return").disabled+" vreturn: "+vreturn);
                var travellers = document.getElementById("travellers").value;
                //console.log(travellers);
                if(travellers == "")
                {
                    document.getElementById("travellers").style.borderBottom = "0.1em solid red";
                    cond = false;
                }
                var vclass = document.getElementById("class").value;
                //console.log(vclass);
                if(cond)
                {
                    window.location.href = "searchresult.html?from_city="+from_city+"&to_city="+to_city+"&departure="+departure+"&vreturn="+vreturn+"&travellers="+travellers+"&vclass="+vclass;
                }
            }

            window.onload = function onLoadFunction()
            {
                var url = new URL(window.location.href.toLowerCase());
                var from_city = url.searchParams.get("from_city");
                var to_city = url.searchParams.get("to_city");
                var departure = url.searchParams.get("departure");
                var vreturn = url.searchParams.get("vreturn");
                var travellers = url.searchParams.get("travellers");
                var vclass = url.searchParams.get("vclass");
                var to_from_div = document.getElementById("to-from");
                var search_info_div = document.getElementById("search-info");
                //console.log(from_city+" to "+to_city);
                if(from_city == "" || to_city == "" || departure == "" || travellers == "" || vclass == "" || from_city == null || to_city == null || departure == null || travellers == null || vclass == null)
                {
                    window.location.href = "index.html";
                }
                else
                {   
                    document.getElementById("from_city").value = from_city;
                    document.getElementById("to_city").value = to_city;
                    document.getElementById("departure").value = departure;
                    document.getElementById("travellers").value = travellers;
                    to_from_div.append(capitalizeFirstLetter(from_city)+" to "+capitalizeFirstLetter(to_city));
                    if(vreturn == "")
                    {
                        search_info_div.append(getDateMonth(departure)+" | "+travellers+" travellers | "+capitalizeFirstLetter(vclass));
                    }
                    else
                    {
                        document.getElementById("return").value = vreturn;
                        document.getElementById("return").disabled = false;
                        var element = document.getElementById("round");
                        element.classList.remove(element.classList);
                        element.classList.add("flight-search-type-active");
                        element = document.getElementById("one");
                        element.classList.remove(element.classList);
                        element.classList.add("flight-search-type-inactive");
                        search_info_div.append(getDateMonth(departure)+" - "+getDateMonth(vreturn)+" | "+travellers+" travellers | "+capitalizeFirstLetter(vclass));
                    }

                    var settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "https://skyscanner-skyscanner-flight-search-v1.p.rapidapi.com/apiservices/autosuggest/v1.0/CA/CAD/en-US/?query="+from_city,
                        "method": "GET",
                        "headers": {
                            "x-rapidapi-host": "skyscanner-skyscanner-flight-search-v1.p.rapidapi.com",
                            "x-rapidapi-key": "4b0e3726ffmshfe15b9274723e0ep136f01jsnc71cc4821441"
                        }
                    }

                    $.ajax(settings).done(function (response) {
                        getToCity(response.Places[0], to_city,departure,vreturn);
                    }).fail(function()
                    {
                        document.getElementById("progres_div").style.display = "none";
                        document.getElementById("no_flights").style.display = "block";
                        document.getElementById("paragraph_error").innerHTML = "An Error Occured!";
                    });
                }
            }

            function getToCity(json, to_city, departure, vreturn)
            {
                var settings = {
                    "async": true,
                    "crossDomain": true,
                    "url": "https://skyscanner-skyscanner-flight-search-v1.p.rapidapi.com/apiservices/autosuggest/v1.0/CA/CAD/en-US/?query="+to_city,
                    "method": "GET",
                    "headers": {
                        "x-rapidapi-host": "skyscanner-skyscanner-flight-search-v1.p.rapidapi.com",
                        "x-rapidapi-key": "4b0e3726ffmshfe15b9274723e0ep136f01jsnc71cc4821441"
                    }
                }

                $.ajax(settings).done(function (response) {
                    //console.log(JSON.stringify(response));
                    getFlightInfo(json, response.Places[0],departure,vreturn);
                }).fail(function()
                {
                    document.getElementById("progres_div").style.display = "none";
                    document.getElementById("no_flights").style.display = "block";
                    document.getElementById("paragraph_error").innerHTML = "An Error Occured!";
                });
            }

            function getFlightInfo(json, json1, departure, vreturn)
            {
                if(vreturn == "")
                {
                    var settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "https://skyscanner-skyscanner-flight-search-v1.p.rapidapi.com/apiservices/browsequotes/v1.0/CA/CAD/en-US/"+json.PlaceId+"/"+json1.PlaceId+"/"+departure,
                        "method": "GET",
                        "dataType": "json",
                        "headers": {
                            "x-rapidapi-host": "skyscanner-skyscanner-flight-search-v1.p.rapidapi.com",
                            "x-rapidapi-key": "4b0e3726ffmshfe15b9274723e0ep136f01jsnc71cc4821441"
                        }
                    }

                    $.ajax(settings).done(function (response) {
                        console.log("response: "+response+" "+typeof(response));
                        var v = JSON.stringify(response);
                        //console.log("v: "+v+" "+typeof(v));
                        response1 = JSON.parse(v);
                        document.getElementById("progres_div").style.display = "none";
                        var quotes = response.Quotes;
                        if(quotes.length == 0)
                        {
                            document.getElementById("no_flights").style.display = "block";
                        }
                        else
                        {
                            var i = 0;
                            quotes.forEach(element => {
                                    var carrier = getCarrierName(element.OutboundLeg.CarrierIds[0], response);
                                    var price = element.MinPrice;
                                    var dep = new Date(element.OutboundLeg.DepartureDate);
                                    var from = getPlace(element.OutboundLeg.OriginId, response);
                                    var to= getPlace(element.OutboundLeg.DestinationId, response);
                                    var is_direct;
                                    if(element.Direct)
                                    {
                                        is_direct = "Non Stop"
                                    }
                                    else
                                    {
                                        is_direct = "Stoppage in Between"
                                    }
                                    const div = "<div class='flight_info' onclick='flightInfoClicked(\""+i+"\",false)'><p>"+carrier+"</p><div class='side_info'><div>"+('0' + dep.getHours()).slice(-2)+":"+('0' + dep.getMinutes()).slice(-2)+"</div><div class='lower_info'>"+from+"</div></div><div class='side_info'><div>"+is_direct+"</div><div class='lower_info'>"+to+"</div></div><div class='side_info price'>$"+price+"</div></div>";
                                    document.getElementById("flight_info_container").innerHTML = document.getElementById("flight_info_container").innerHTML + div;
                                i+=1;
                            });
                        }
                    }).fail(function()
                    {
                        document.getElementById("progres_div").style.display = "none";
                        document.getElementById("no_flights").style.display = "block";
                        document.getElementById("paragraph_error").innerHTML = "An Error Occured!";
                    });
                }
                else
                {
                    var settings = {
                        "async": true,
                        "crossDomain": true,
                        "url": "https://skyscanner-skyscanner-flight-search-v1.p.rapidapi.com/apiservices/browsequotes/v1.0/CA/CAD/en-US/"+json.PlaceId+"/"+json1.PlaceId+"/"+departure+"?inboundpartialdate="+vreturn,
                        "method": "GET",
                        "dataType": "json",
                        "headers": {
                            "x-rapidapi-host": "skyscanner-skyscanner-flight-search-v1.p.rapidapi.com",
                            "x-rapidapi-key": "4b0e3726ffmshfe15b9274723e0ep136f01jsnc71cc4821441"
                        }
                    }

                    $.ajax(settings).done(function (response) {
                        console.log("response: "+response+" "+typeof(response));
                        var v = JSON.stringify(response);
                        console.log("v: "+v+" "+typeof(v));
                        response1 = JSON.parse(v);
                        document.getElementById("progres_div").style.display = "none";
                        var quotes = response.Quotes;
                        if(quotes.length == 0)
                        {
                            document.getElementById("no_flights").style.display = "block";
                        }
                        else
                        {
                            var i = 0;
                            quotes.forEach(element => {
                                var carrier = getCarrierName(element.OutboundLeg.CarrierIds[0], response);
                                var price = element.MinPrice;
                                var dep = new Date(element.OutboundLeg.DepartureDate);
                                var from = getPlace(element.OutboundLeg.OriginId, response);
                                var to= getPlace(element.OutboundLeg.DestinationId, response);
                                var is_direct;
                                if(element.Direct)
                                {
                                    is_direct = "Non Stop"
                                }
                                else
                                {
                                    is_direct = "Stoppage in Between"
                                }
                                const div = "<div class='flight_info' onclick='flightInfoClicked(\""+i+"\",true)'><p>"+carrier+"</p><div class='side_info'><div>"+('0' + dep.getHours()).slice(-2)+":"+('0' + dep.getMinutes()).slice(-2)+"</div><div class='lower_info'>"+from+"</div></div><div class='side_info'><div>"+is_direct+"</div><div class='lower_info'>"+to+"</div></div><div class='side_info price'>$"+price+"</div>"+
                                "<div><div class='return_flight'>Return</div><p class='return_flight_name'>"+carrier+"</p><div class='side_info'><div>"+('0' + dep.getHours()).slice(-2)+":"+('0' + dep.getMinutes()).slice(-2)+"</div><div class='lower_info'>"+to+"</div></div><div class='side_info'><div>"+is_direct+"</div><div class='lower_info'>"+from+"</div></div><div class='side_info price'>$"+price+"</div></div>"+"</div>";
                                document.getElementById("flight_info_container").innerHTML = document.getElementById("flight_info_container").innerHTML + div;
                                i+=1;
                            });
                        }
                    }).fail(function()
                    {
                        document.getElementById("progres_div").style.display = "none";
                        document.getElementById("no_flights").style.display = "block";
                        document.getElementById("paragraph_error").innerHTML = "An Error Occured!";
                    });
                }
            }

            function flightInfoClicked(index, isreturning)
            {
                var url = new URL(window.location.href);
                var vreturn = url.searchParams.get("vreturn");
                var travellers = url.searchParams.get("travellers");
                var vclass = url.searchParams.get("vclass");
                window.location.href = "flight_review.html?data="+JSON.stringify(response1)+"&index="+index+"&isreturning="+isreturning+"&vclass="+vclass+"&vreturn="+vreturn+"&travellers="+travellers;
            }

        </script>
    </body>
</html>